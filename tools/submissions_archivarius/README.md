# Submissions Archivarius

`submissions_archivarius` is a small utility designed to monitor a directory for incoming files and archive them into compressed tarballs once a certain number of files is reached. This is useful for managing large volumes of small files, such as those generated by a web service or data collection agent.
In our case, it is used to archive JSON files generated by the KernelCI submission service (kcidb-rest).

The tool is written in Rust and can be run as a standalone command-line application or as a systemd service.

## Logic

1) Watches a source directory for new files.
2) Archives files into `.tar.xz` bundles when a specified file count is met.

Configurable via command-line arguments or environment variables. Includes a script for easy installation as a systemd service.
Upload to remote storage is planned but not yet implemented.

## Building

To build the project, you will need to have the Rust toolchain installed.

1.  Clone the repository.
2.  Navigate to the `submissions_archivarius` directory.
3.  Build the project in release mode:

    ```bash
    cargo build --release
    ```

The compiled binary will be located at `target/release/submissions_archivarius`.

## Usage

The tool can be run directly from the command line.

### Command-Line Options

| Option                | Environment Variable            | Default Value | Description                                                                 |
| --------------------- | ------------------------------- | ------------- | --------------------------------------------------------------------------- |
| `--sourcedir`         | `ARCHIVARIUS_SRCDIR`            | (required)    | The source directory to watch for files.                                    |
| `--destdir`           | `ARCHIVARIUS_DESTDIR`           | (required)    | The destination directory where archives will be saved.                     |
| `--number`            | `ARCHIVARIUS_NUMBER`            | `50000`       | The number of files to accumulate before creating an archive.               |
| `--suffix`            | `ARCHIVARIUS_SUFFIX`            | `.json`       | The file suffix to look for.                                                |
| `--compression-level` | `ARCHIVARIUS_COMPRESSION_LEVEL` | `1`           | The compression level for xz (0-9).                                         |
| `--upload`            | `ARCHIVARIUS_UPLOAD`            | (none)        | Optional upload configuration string (e.g., a URL or connection string).    |
| `-v`, `--verbose`     |                                 | `false`       | Enable verbose output for detailed logging.                                 |

### Example

```bash
./target/release/submissions_archivarius \
    --sourcedir /path/to/source \
    --destdir /path/to/destination \
    --number 10000 \
    --verbose
```

## Systemd Service Installation

The `install_systemd.sh` script is provided to simplify the installation of `submissions_archivarius` as a systemd service.

**Note:** The script must be run with `sudo` or as the root user.

### Installation Steps

1.  Build the binary as described in the [Building](#building) section.
2.  Run the installation script:

    ```bash
    sudo ./install_systemd.sh
    ```

The script will perform the following actions:

-   Copy the `submissions_archivarius` binary to `/usr/local/bin/`.
-   Create a systemd service file at `/etc/systemd/system/submissions-archivarius.service`.
-   Create the necessary source and destination directories (`/home/azureuser/kcidb-rest/spool/archive` and `/home/azureuser/archive`).
-   Set ownership of the directories to the `azureuser`.
-   Reload the systemd daemon and enable the service to start on boot.

The service is configured by default to run as the `azureuser` and uses environment variables set within the service file for configuration. You can edit the service file to change these settings if needed.

